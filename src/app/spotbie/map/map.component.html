<app-loading-screen *ngIf="loading"></app-loading-screen>

<div class="spotbie-map">
  
  <div class="map-prompt-mobile" *ngIf="showMobilePrompt">

    <div class="sb-filler loggedInFiller" *ngIf="isLoggedIn == '1'"></div>

    <div class="sb-filler"></div>
    
    <div class="sb-button" (click)="mobileStartLocation()" *ngIf="isLoggedIn == '1'">
      Start Location Services
    </div>

    <swiper [config]="swiperConfig" *ngIf="isLoggedIn != '1'">

      <div class="swiper-wrapper">

        <div class="swiper-slide" *ngFor="let slide of slideShowSources" [ngStyle]="{ 'background' : 'url(' + slide.imageUrl + ')' }">

          <div class="sb-filler"></div>

          <div class="sb-button" (click)="mobileStartLocation()">
            {{ slide.text }}
          </div>

        </div>

      </div>

      <!-- Add Pagination -->
      <div class="swiper-pagination"></div>

      <!-- Add Arrows -->
      <div class="swiper-button-next">
        <i class="fa fa-angle-right"></i>
      </div>
      <div class="swiper-button-prev">
        <i class="fa fa-angle-left"></i>
      </div>

    </swiper>

  </div>

  <div class="map-prompt-mobile" *ngIf="showMobilePrompt2" (click)="mobilePrompt2Toggle()">

    <div class="title" (click)="mobilePrompt2Toggle()">
      Tap Here to Begin.
    </div>

  </div>

  <agm-map class="spotbie-map"
            (click)="mobilePrompt2ToggleOff()"
            (boundsChange)="mobilePrompt2ToggleOff()"
            [gestureHandling]="'greedy'"
            [streetViewControl]="false"
            #spotbie_map
            [latitude]="lat" 
            [longitude]="lng"
            [styles]="map_styles"
            [zoom]="32"
            [fitBounds]="true">

    <agm-overlay [latitude]="lat" [longitude]="lng" *ngIf="locationFound">

      <div class='spotbie-marker-bg'
          *ngIf="iconUrl"
          [ngStyle]="{'background' : 'url(' + iconUrl + ')',                      
                      'border' : '2px solid ' + bg_color }">
      </div>
          
    </agm-overlay>

    <agm-marker [latitude]="lat" 
                [longitude]="lng"
                *ngIf="locationFound"
                [opacity]="0"
                (markerClick)="selfMarker()"
                [agmFitBounds]="true">

        <agm-info-window #spotbie_user_marker_info_window [isOpen]="true">
          
          <div class='agm_infowindow_color'>{{ spotbie_username }}</div>
          
        </agm-info-window>

    </agm-marker>

    <div *ngIf="displaySurroundingObjectList">

      <agm-overlay *ngFor="let mapObject of surrounding_object_list"                  
                    [latitude]="mapObject.loc_x"
                    [longitude]="mapObject.loc_y">

        <div class='spotbie-marker-bg' 
              (click)="pullMarker(mapObject)"
              title="{{ mapObject.username }}"
              [ngStyle]="{'background' : 'url(' + mapObject.map_icon + ')',
                          'border' : '2px solid ' + mapObject.bg_color }">
        </div>

      </agm-overlay>  
        
    </div>

    <div *ngIf="show_search_box && searchResults.length > 0">

      <agm-overlay *ngFor="let mapObject of searchResults"
                    [latitude]="mapObject.coordinates.latitude" 
                    [longitude]="mapObject.coordinates.longitude">

        <div class='spotbie-marker-bg'
              (click)="pullSearchMarker(mapObject)"
              [ngStyle]="{'background' : 'url(' + mapObject.icon + ')',
                          'border' : '2px solid #5c7b36' }">
        </div>

      </agm-overlay>                    
      
      <agm-marker *ngFor="let mapObject of searchResults"
                  [latitude]="mapObject.coordinates.latitude" 
                  [longitude]="mapObject.coordinates.longitude"
                  [agmFitBounds]="true"
                  [visible]="false"></agm-marker>
      
    </div>

  </agm-map>

</div>

<app-info-object [info_object]="infoObject" (closeWindow)="infoObjectWindow.open = false" *ngIf="infoObjectWindow.open"></app-info-object>

<div class="spotbie-map-search-wrapper">

  <table class='spotbie-map-search-by' id="spotbie-search-by" *ngIf="locationFound">

    <tr>

      <td (click)="spotMe()" title="Find Me">
        <div id='spotbie_me_search'></div>
      </td>

      <td (click)="spawnCategories('food')" title="Find Food">
        <i class="fa fa-cutlery" aria-hidden="true"></i>
      </td>   

      <td (click)="spawnCategories('shopping')" title="Find Shopping Places">
        <i class="fa fa-shopping-cart" aria-hidden="true"></i>
      </td> 

      <td (click)="spawnCategories('events')" title="Find Events">
        <div id='spotbie_events_search'></div>
      </td> 

      <!--<td (click)="mediaSearch(0)" title="Find Media" *ngIf="isLoggedIn == '1'">
        <div id='spotbie_media_search'></div>
      </td>-->

      <!--<td (click)="placeSearch()" title="My Places">
        <div id='spotbie_place_search'></div>
      </td>-->

      <td (click)="myFavorites()" title="My Favorites">
        <i class="fa fa-star" aria-hidden="true"></i>
      </td>

    </tr>
  </table>
  
</div>


<div class='spotbie-category-search-yelp animated slideInUp' *ngIf="catsUp">
  <input type='text' class='spotbie-searchbar sb-input' placeholder="{{ search_categories_placeholder }}" (keyup)="searchSpotBie($event)" />
  <div class='spotbie-close-categories' (click)="closeCategories()" *ngIf="catsUp">close</div>
</div>

<div class='spotbie-categories animated slideInRight' *ngIf="catsUp && search_category != 'events'" [ngStyle]="{ 'background-color' : bg_color }">

  <div class='spotbie-single-cat' *ngFor="let category of categories" (click)="apiSearch(category)">
    {{ category }}
  </div>

</div>

<div class='spotbie-categories animated slideInRight' *ngIf="catsUp && search_category == 'events'" [ngStyle]="{ 'background-color' : bg_color }">

  <div class='spotbie-single-cat' *ngFor="let category of categories" (click)="showEventSub(category)">
    
    {{ category.name }}

    <!--<div class='spotbie-sub-cat-wrapper' *ngIf="category.show_sub && category.type !== undefined">

      <div class='spotbie-sub-cat' *ngFor="let sub_cat_type of category.type._embedded.subtypes" (click)="apiSearch(sub_cat_type.name)" [SpotBieStopClickPropagation]>
        
        {{ sub_cat_type.name }}

      </div>

    </div>-->

    <div class='spotbie-sub-cat-wrapper' *ngIf="category.show_sub && category.segment !== undefined">

      <div class='spotbie-sub-cat' *ngFor="let sub_cat_type of category.segment._embedded.genres" (click)="apiSearch(sub_cat_type.name)" [SpotBieStopClickPropagation]>
        
        {{ sub_cat_type.name }}

        <!--<div *ngIf="sub_cat_type.show_sub_sub">

          <div class='spotbie-subgenre' *ngFor="let subgenre of sub_cat_type._embedded.subgenres" (click)="apiSearch(subgenre.name)" [SpotBieStopClickPropagation]>

            {{ subgenre.name }}
  
          </div>

        </div> -->

      </div>

    </div>    

  </div>

</div>

<div class='spotbie-search-results' *ngIf="show_search_box && searchResults.length > 0">

  <div class='spotbie-close-results-mobile' (click)="closeSearchResults()">close</div>

  <div class='spotbie-close-results' (click)="closeSearchResults()">close</div>

  <!--<table class='spotbie-pull-from'>
    <tr>
      <td (click)="pullFrom('yelp')" class='spotbie-api-pull' [ngStyle]="getApiPullStyle('yelp')" title="Pull from Yelp">YELP</td>
      <td (click)="pullFrom('google')" class='spotbie-api-pull' [ngStyle]="getApiPullStyle('google')" title="Pull from Google">Google</td>
    </tr>
  </table>-->

  <div class='spotbie-search-results-title' *ngIf="type_of_info_object == 'yelp_business'">
    Max Distance  <mat-slider min="0" max="25" step="1" value="{{ maxDistance }}"
                            (change)="updateDistance($event)"></mat-slider>
    {{ maxDistance }} miles.                            
  </div>

  <div class='spotbie-search-results-title' *ngIf="type_of_info_object == 'ticketmaster_events'">
    Max Distance  <mat-slider min="0" max="50" step="1" value="{{ maxDistance }}"
                            (change)="updateDistance($event)"></mat-slider>
    {{ maxDistance }} miles.                            
  </div>

  <table class='spotbie-controls-search-results' *ngIf="searchCategorySorter == 'food'">
    <tr>
      <td (click)="hideSearchResults()" title="Hide Results"><img src='assets/images/eye.png' /></td>
      <td (click)="sortBy(0)" title="Sort By Distance"><img src='assets/images/road.png' /></td>
      <td (click)="sortBy(1)" title="Sort By Rating"><img src='assets/images/star.png' /></td>
      <td (click)="sortBy(2)" title="Sort By Reviews"><img src='assets/images/review.png' /></td>
      <td (click)="sortBy(3)" title="Sory By Pricing"><img src='assets/images/money.png' /></td>
      <td (click)="sortBy(4)" title="Offers Delivery"><img src='assets/images/bag.png' /></td>
      <td (click)="sortBy(5)" title="Offers Pick-Up"><img src='assets/images/arm.png' /></td>
      <td (click)="sortBy(6)" [ngStyle]="{ 'border-right' : 'unset' }" title="Offers Reservations"><img src='assets/images/hotel.png' /></td>
    </tr>    
  </table>

  <table class='spotbie-controls-search-results' *ngIf="searchCategorySorter == 'shopping'">
    <tr>
      <td (click)="hideSearchResults()" title="Hide Results"><img src='assets/images/eye.png' /></td>
      <td (click)="sortBy(0)" title="Sort By Distance"><img src='assets/images/road.png' /></td>
      <td (click)="sortBy(1)" title="Sort By Rating"><img src='assets/images/star.png' /></td>
      <td (click)="sortBy(2)" title="Sort By Reviews"><img src='assets/images/review.png' /></td>
      <td (click)="sortBy(3)" [ngStyle]="{ 'border-right' : 'unset' }"  title="Sory By Pricing"><img src='assets/images/money.png' /></td>
    </tr>    
  </table>

  <table class='spotbie-controls-search-results' *ngIf="searchCategorySorter == 'events'">
    <tr>
      <td (click)="hideSearchResults()" title="Hide Results"><img src='assets/images/eye.png' /></td>
      <td (click)="sortBy(0)" title="Sort By Distance"><img src='assets/images/road.png' /></td>
      <td (click)="sortBy(3)" [ngStyle]="{ 'border-right' : 'unset' }"  title="Sory By Pricing"><img src='assets/images/money.png' /></td>
    </tr>    
  </table>

  <div class='spotbie-search-results-title spotbie-sorting'>

    Sorted by {{ sort_by_txt }} ({{ sorting_order }})

  </div>

  <div class='spotbie-search-result-wrapper'>

    <div class='spotbie-search-results-title'>

      <span *ngIf="search_category !== 'events'">Showing {{ loadedTotalResults }} results within {{ maxDistance }} miles. </span>
  
      <span class='sb-button' (click)="loadMoreResults(0)" *ngIf="allPages > 1">
        Previous
      </span>   

      <span class='sb-button' (click)="loadMoreResults(1)" *ngIf="allPages > 1">
        Next
      </span>
  
      <span class='spotbie-search-page-number'>{{ around_me_search_page }} / {{ allPages }}</span>
  
    </div>
    
    <div class='spotbie-no-results' *ngIf='searchResults.length == 0'>No Results Available.</div>

    <div class='spotbie-search-result' *ngFor='let search_result of searchResults' (click)="pullSearchMarker(search_result)">
      
      <div class='spotbie-search-result-title' >
        
        {{ search_result.name }} 
        
        <span class='spotbie-search-result-price' *ngIf="search_result.price_on == '1'">({{ search_result.price }})</span>

      </div>
      
      <table class='spotbie-search-result-table'>
        <tr>
          
          <td *ngIf="search_result.image_url != '0'">
            <div class='spotbie-search-result-image'[ngStyle]="{ 'background' : 'url(' + search_result.image_url + ')' }" ></div>          
          </td>
          
          <td *ngIf="type_of_info_object == 'yelp_business'">

            <table class='spotbie-yelp-rating-table'>
              <tr>
                <td>
                  <div class='spotbie-search-result-rating-img' [ngStyle]="{ 'background' : 'url(' + search_result.rating_image + ')' }"></div>
                </td>
                <td>
                  <div class='spotbie-search-result-yelp-logo' [ngStyle]="{ 'background' : 'url(assets/images/yelp/yelp_logo.png)' }"></div>
                </td>
              </tr>
            </table>
  
            <div class='spotbie-review-count'>
              Based on {{ search_result.review_count }} Reviews
            </div>

            <div class='spotbie-distance'>
              {{ search_result.distance }} miles from you.
            </div>                        

            <div class='spotbie-search-result-phone' *ngIf="search_result.phone != ''">
              {{ search_result.display_phone }}
            </div>       

          </td>

          <td *ngIf="type_of_info_object == 'ticketmaster_events'">

            <div class='spotbie-venue-name' *ngIf="search_result._embedded.venues[0]">
              {{ search_result._embedded.venues[0].name }}
            </div>

            <div class='spotbie-distance'>
              {{ search_result.distance }} miles from you.
            </div>
                        
            <div class='spotbie-time-event' *ngIf="search_result.dates.start.localDate">
              {{ search_result.dates.start.spotbieDate }}
            </div>

            <div class='spotbie-time-event' *ngIf="search_result.dates.start.spotbieHour">
              {{ search_result.dates.start.spotbieHour }}
            </div>

            <div class='spotbie-price-ranges' *ngIf="search_result.priceRanges !== undefined">
              Price Ranges ${{ search_result.priceRanges[0].min }} to ${{ search_result.priceRanges[0].max }}
            </div>

            <div class='spotbie-event-code' *ngIf="search_result.dates.status.code">
              Status: {{ search_result.dates.status.code }}
            </div>      

          </td>

        </tr>

      </table>
  
      <div class='spotbie-search-result-transactions' *ngIf="search_result.transactions_on == '1'">{{ search_result.friendly_transactions }}</div>
  
    </div>

    <div>

      <span class='sb-button' (click)="loadMoreResults(0)" *ngIf="allPages > 1">
        Previous
      </span>   
  
      <span class='sb-button' (click)="loadMoreResults(1)" *ngIf="allPages > 1">
        Next
      </span>
  
      <div class='spotbie-search-results-title' style="text-align: center;">
          {{ around_me_search_page }} / {{ allPages }}
      </div>

    </div>

  </div>

</div>

<div class='spotbie-search-results no-results' *ngIf="showNoResultsBox">
  
  <div class='spotbie-no-results' style="text-align: center;">No Results Available for "{{ search_keyword }}" within {{ maxDistance }} miles.</div>

  <div class='spotbie-search-results-title'>
    Max Distance  <mat-slider min="0" max="{{ maxDistanceCap }}" step="1" value="{{ maxDistance }}"
                            (change)="updateDistance($event)"></mat-slider>
    {{ maxDistance }} miles.                            
  </div>

</div>

<app-user-info-object [currentMarker]="currentMarker" *ngIf="sliderRight" (close)="sliderRight = false"></app-user-info-object>

<div class="spotbie-overlay-window" *ngIf="coming_soon_ov" [ngStyle]="{'background-color' : bg_color}">

  <div class='spotbie-coming-soon'>
    {{coming_soon_ov_title}}
  </div>

  <div class='spotbie-coming-soon-desc'>
    {{coming_soon_ov_text}}
  </div>    

  <div class="sb-closeButton" (click)="closeCmS()"><i class="fa fa-times"></i></div>

</div>

<app-welcome *ngIf="locationPrompt" (locationPrompted)="acceptLocationPrompt()"></app-welcome>

<app-my-favorites *ngIf='myFavoritesWindow.open' (closeWindow)="myFavoritesWindow.open = false"></app-my-favorites>

<app-location-saver *ngIf='myPlacesWindow.open' (closeWindow)="myPlacesWindow.open = false"></app-location-saver>

<app-toast-helper [helper_config]="toastHelperConfig" 
                  *ngIf="toastHelper"
                  (dismiss_toast)="dismissToast($event)"></app-toast-helper>